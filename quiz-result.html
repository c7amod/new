<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نتيجة الاختبار</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { transition: opacity 600ms ease; }
    body.page-enter { opacity: 0; }
    body.page-enter-active { opacity: 1; }
    .reveal-on-scroll { opacity: 0; transform: translateY(10px); transition: opacity 600ms ease, transform 600ms ease; }
    .reveal-active { opacity: 1; transform: translateY(0); }
    .nav-anim { position: relative; }
    .nav-anim::after { content: ""; position: absolute; right: 0; bottom: -4px; height: 2px; width: 0; background: rgb(79 70 229); transition: width 300ms ease; }
    .nav-anim:hover::after { width: 100%; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .card-enter { animation: fadeUp 420ms ease both; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 page-enter">
  <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between relative">
      <div class="flex items-center gap-2">
        <a href="index.html" aria-label="العودة للصفحة الرئيسية" class="absolute left-3 md:-left-3 lg:-left-4 top-1/2 -translate-y-1/2 inline-flex items-center">
          <img src="assets/clearmed.png" alt="ClearMed banner" class="h-10 w-auto object-contain"/>
        </a>
      </div>
      <nav class="flex items-center gap-4 sm:gap-6 absolute right-3 sm:right-4 top-1/2 -translate-y-1/2">
        <a href="index.html" class="hover:text-indigo-600 nav-anim">الرئيسية</a>
        <a href="terminology.html#tests" class="hover:text-indigo-600 nav-anim">الاختبارات</a>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="rounded-lg border bg-white p-6 card-enter">
      <h1 id="resultTitle" class="text-2xl font-bold mb-2">نتيجة الاختبار</h1>
      <p id="scoreText" class="text-slate-700">—</p>
      <p id="timeText" class="text-slate-600 mb-6">—</p>
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <a id="btnRetry" href="#" class="rounded-md bg-indigo-600 text-white px-4 py-1.5 text-sm shadow-sm hover:bg-indigo-700 transition-transform hover:-translate-y-0.5">إعادة الاختبار</a>
        <a id="btnReviewIncorrect" href="#" class="rounded-md border border-slate-300 text-slate-700 px-4 py-1.5 text-sm hover:bg-slate-50 transition-transform hover:-translate-y-0.5">استعراض الإجابات الخاطئة</a>
        <a id="btnReviewAll" href="#" class="rounded-md border border-slate-300 text-slate-700 px-4 py-1.5 text-sm hover:bg-slate-50 transition-transform hover:-translate-y-0.5">استعراض كل الإجابات</a>
        <a id="btnBack" href="terminology.html#tests" class="ml-auto rounded-md border border-slate-300 text-slate-700 px-4 py-1.5 text-sm hover:bg-slate-50">العودة إلى قائمة الاختبارات</a>
      </div>
    </div>

    <div id="summaryBox" class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="rounded-lg border bg-white p-4 text-center card-enter">
        <div class="text-sm text-slate-600">الأسئلة الصحيحة</div>
        <div id="correctCount" class="text-2xl font-bold">-</div>
      </div>
      <div class="rounded-lg border bg-white p-4 text-center card-enter">
        <div class="text-sm text-slate-600">إجمالي الأسئلة</div>
        <div id="totalCount" class="text-2xl font-bold">-</div>
      </div>
      <div class="rounded-lg border bg-white p-4 text-center card-enter">
        <div class="text-sm text-slate-600">النسبة المئوية</div>
        <div id="percentVal" class="text-2xl font-bold">-</div>
      </div>
    </div>
  </main>

  <footer class="border-t bg-white mt-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-sm text-slate-600 text-left">© 2025 clearmed.site</div>
  </footer>

  <script>
    // Page enter + bfcache
    document.addEventListener('DOMContentLoaded', () => {
      requestAnimationFrame(() => {
        document.body.classList.add('page-enter-active');
        document.body.classList.remove('page-enter');
      });
    });
    window.addEventListener('pageshow', () => {
      document.body.classList.add('page-enter-active');
      document.body.classList.remove('page-enter');
    });

    function loadPayload() {
      try {
        const raw = sessionStorage.getItem('quiz_payload');
        return raw ? JSON.parse(raw) : null;
      } catch (e) { return null; }
    }

    function formatMs(ms){
      const n = Number(ms);
      const sec = Number.isFinite(n) ? Math.max(0, Math.round(n/1000)) : 0;
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = (sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function resolveDurationMs(payload){
      if (payload && payload.durationMs != null && Number.isFinite(Number(payload.durationMs))) {
        return Number(payload.durationMs);
      }
      try {
        const d = sessionStorage.getItem('quiz_last_duration');
        if (d && Number.isFinite(Number(d))) return Number(d);
      } catch(_) {}
      try {
        const s = sessionStorage.getItem('quiz_start');
        const e = sessionStorage.getItem('quiz_end');
        if (s && e) {
          const ms = Number(e) - Number(s);
          if (Number.isFinite(ms)) return ms;
        }
      } catch(_) {}
      return 0;
    }

    const payload = loadPayload();
    if (payload) {
      const { correctCount, total, score, title } = payload;
      const durationMs = resolveDurationMs(payload);
      document.getElementById('resultTitle').textContent = title ? `نتيجة الاختبار — ${title}` : 'نتيجة الاختبار';
      document.getElementById('correctCount').textContent = correctCount;
      document.getElementById('totalCount').textContent = total;
      document.getElementById('percentVal').textContent = score + '%';
      document.getElementById('scoreText').textContent = `درجتك: ${correctCount} / ${total} (${score}%)`;
      document.getElementById('timeText').textContent = `الوقت المستغرق: ${formatMs(durationMs)}`;
    } else {
      document.getElementById('scoreText').textContent = 'لم يتم العثور على نتيجة. برجاء إجراء الاختبار مرة أخرى.';
    }

    // Actions
    document.getElementById('btnRetry').addEventListener('click', (e) => {
      e.preventDefault();
      try {
        const next = sessionStorage.getItem('quiz_last_source');
        if (next) { window.location.href = next; return; }
      } catch(_) {}
      window.location.href = 'terminology.html#tests';
    });
    document.getElementById('btnReviewIncorrect').addEventListener('click', (e) => {
      e.preventDefault();
      sessionStorage.setItem('quiz_review', 'incorrect');
      try {
        const next = sessionStorage.getItem('quiz_last_source');
        if (next) { window.location.href = next; return; }
      } catch(_) {}
      window.location.href = 'terminology.html#tests';
    });
    document.getElementById('btnReviewAll').addEventListener('click', (e) => {
      e.preventDefault();
      sessionStorage.setItem('quiz_review', 'all');
      try {
        const next = sessionStorage.getItem('quiz_last_source');
        if (next) { window.location.href = next; return; }
      } catch(_) {}
      window.location.href = 'terminology.html#tests';
    });
  </script>
</body>
</html>
